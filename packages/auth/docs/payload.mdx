import { Meta } from '@storybook/blocks';

<Meta title="Authentication/Payload" />

# PayloadCMS Authentication

`@cortex-shared/auth` provides boilerplate authentication patterns for PayloadCMS and associated API routes.

## Features

- üîê JWT / Bearer token based API usage
- ‚úÖ Payload native authentication integrated with OIDC providers (like Keycloak)
- üõ°Ô∏è Oauth Token Exchange patterns

## Installation

```bash
npm install cortex-auth
# or
pnpm add cortex-auth
```

## Setup

`pnpm i payload-authjs next-auth@^5.0.0-beta`
This plugin integrates Auth.js into Payload CMS by getting the user session from Auth.js. You need to setup Auth.js before you can use this plugin.

There is some base-level setup required to use authentication. We use payload-authjs and authjs as well as custom code within this module.

### Create your Auth.js configuration

Define your Auth.js configuration in a file (e.g. `auth.config.ts`):

```ts
// auth.config.ts
import type { NextAuthConfig } from "next-auth";
import github from "next-auth/providers/github";

export const authConfig: NextAuthConfig = {
  providers: [
    github, // <-- Add your provider here
  ],
};
```

### Add Auth.js route handler

Add the Auth.js route handler under `/app/(auth)api/auth/[...nextauth]/route.ts`:

```js
// app/(auth)/api/auth/[...nextauth]/route.ts
import { handlers } from "@/lib/auth";
export const { GET, POST } = handlers;
```

### Create your Auth.js instance

Next, create your Auth.js instance in a file (e.g. `auth.ts`).

> ‚ö† But unlike what you would normally do in Auth.js, you need to create the Payload instance first and using the `getAuthjsInstance` function to retrieve the Auth.js instance.

```js
// lib/auth.ts
import payloadConfig from "@payload-config";
import { getPayload } from "payload";
import { getAuthjsInstance } from "payload-authjs";

const payload = await getPayload({ config: payloadConfig });
export const { handlers, signIn, signOut, auth } = getAuthjsInstance(payload);
```

### Add the payload-authjs plugin to Payload CMS

```js
// payload.config.ts
import { authjsPlugin } from "payload-authjs";
import { authConfig } from "./auth.config";

export const config = buildConfig({
  plugins: [
    authjsPlugin({
      authjsConfig: authConfig,
    }),
  ],
});
```

### Add Auth.js proxy / middleware (optional)

Add optional `proxy.ts`/`middleware.ts` to keep the session alive, this will update the session expiry each time it's called.

> Since Next.js 16, the `middleware` has been replaced with the `proxy` and uses the nodejs runtime. See the [Next.js docs](https://nextjs.org/docs/app/guides/upgrading/version-16#middleware-to-proxy).

##### Next.js 16 or above

```ts
// proxy.ts
export { auth as proxy } from "./auth";

export const config = {
  matcher: ["/((?!api|_next/static|_next/image|favicon.ico|admin).*)"],
};
```

##### Next.js 15

> ‚ö† Unlike what you would normally do in Auth.js, you cannot use the `middleware` of `@/auth` directly. You have to create a new Auth.js instance to be [edge-compatible](https://authjs.dev/guides/edge-compatibility).

```ts
// middleware.ts
import NextAuth from "next-auth";
import { authConfig } from "./auth.config";

export const { auth: middleware } = NextAuth(authConfig);

export const config = {
  matcher: ["/((?!api|_next/static|_next/image|favicon.ico|admin).*)"],
};
```
